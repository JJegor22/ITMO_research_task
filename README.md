# ITMO_research_task
Данная работа представляет собой разведочный анализ данных для вступительного исптыания в ИТМО AI Talent Hub "Искусственный интеллект"
Были поставлены задачи:
- Провести разведочный анализ данных;
- Придумать продуктовые и технические гипотезы - какую ценность можно извлечь из данных для организации, которая предоставила данные.

В ходе работы было сделано:
- Проведен анализ данных, проверены поставленные гипотезы
- Построены и исследованы модели на основе градиентого бустинга

<details>
  <summary> Полная информация о данных</summary>
  # Общее описание `transaction_fraud_data.parquet`

Этот анонимизированный набор данных реальных финансовые транзакции, который предназначен для разработки и тестирования моделей выявления мошеннических операций.

Он охватывает различные сценарии — от розничной торговли и ресторанов до путешествий и здравоохранения — и включает как легитимные, так и мошеннические операции. В нём представлены важные признаки, влияющие на распознавание мошенничества: сумма, тип устройства, география, валюта, тип карты и метка `is_fraud`.

## Ключевые особенности

- **Разнообразие категорий**: Розница (онлайн и офлайн), рестораны (фастфуд и премиум), развлечения, здравоохранение, образование, топливо, путешествия и др.
- **География и валюта**: Транзакции охватывают разные страны, города и валюты, что позволяет моделировать глобальные риски.
- **Профили клиентов**: Для каждой транзакции предусмотрены данные о клиенте — возраст аккаунта, используемые устройства, типичные траты, уровень защиты от мошенничества.
- **Данные, готовые для ML**: Признаки включают скорость транзакций, риск вендора, присутствие карты, отпечатки устройств и другие факторы, помогающие обнаруживать подозрительные паттерны.

## Возможные применения

- Построение моделей выявления мошенничества.
- Анализ транзакционного поведения клиентов.
- Разработка и тестирование алгоритмов обнаружения аномалий.
- Изучение методов feature engineering, оценки моделей и оптимизации производительности в сфере финтеха и e-commerce.


# Содержание файла `transaction_fraud_data.parquet`

| Поле | Описание | Тип |
|------|----------|-----|
| `transaction_id` | Уникальный идентификатор транзакции | String | 
| `customer_id` | Уникальный идентификатор клиента | String | 
| `card_number` | Маскированный номер карты | Int64 |
| `timestamp` | Дата и время транзакции | Datetime(time_unit='us') |
| `vendor_category` | Общая категория вендора (например, Розница, Путешествия) | String |
| `vendor_type` | Тип вендора внутри категории (например, "онлайн") | String |
| `vendor` | Название вендора | String |
| `amount` | Сумма транзакции | Float64 |
| `currency` | Валюта (например, USD, EUR, JPY) | String |
| `country` | Страна, где проведена транзакция | String |
| `city` | Город, где проведена транзакция | String |
| `city_size` | Размер города (например, средний, крупный) | String |
| `card_type` | Тип карты (например, Basic Credit, Gold Credit) | String |
| `is_card_present` | Присутствовала ли карта физически при оплате (POS) | Boolean |
| `device` | Устройство, с которого проведена транзакция (например, Chrome, iOS App) | String |
| `channel` | Канал проведения транзакции (веб, мобильный, POS) | String |
| `device_fingerprint` | Уникальный отпечаток устройства | String |
| `ip_address` | IP-адрес транзакции | String | 
| `is_outside_home_country` | Признак того, что операция проведена вне страны клиента | Boolean |
| `is_high_risk_vendor` | Является ли категория вендора рискованной (например, Путешествия, Развлечения) | Boolean |
| `is_weekend` | Произошла ли операция в выходной день | Boolean |
| `last_hour_activity` | Показатели активности за последний час в виде вложенной структуры | Struct({'num_transactions': Int64, 'total_amount': Float64, 'unique_merchants': Int64, 'unique_countries': Int64, 'max_single_amount': Float64}) |
| `is_fraud` | Является ли транзакция мошеннической (`True` / `False`) | Boolean |

Составное поле `last_hour_activity`:

| Ключ | Описание | Тип |
|------|----------|-----|
| `num_transactions` | Количество транзакций | Int64 |
| `total_amount` | Общая сумма транзакций | Float64 |
| `unique_merchants` | Число уникальных продавцов | Int64 |
| `unique_countries` | Число уникальных стран | Int64 |
| `max_single_amount` | Максимальная сумма одной транзакции | Float64 |


# Содержание файла `historical_currency_exchange.parquet`

Вспомогательные данные для перевода операций в нужную валюту.

Обменный курс с `2024-09-30` по `2024-10-30` относительно `USD`.

| Поле | Описание | Тип |
|------|----------|-----|
| `date` | Дата обменного курса | Date | 
| `AUD` | Австралийский доллар | Float64 | 
| `BRL` | Бразильский реал | Float64 |
| `CAD` | Канадский доллар | Float64 |
| `EUR` | Евро | Float64 |
| `GBP` | Британский фунт стерлингов | Float64 |
| `JPY` | Японская иена | Float64 |
| `MXN` | Мексиканское песо | Float64 |
| `NGN` | Нигерийская найра | Float64 |
| `RUB` | Российский Рубль | Float64 |
| `SGD` | Сингапурский доллар | Float64 |
| `USD` | Доллар США | Int64 |

</details>

# Данные
Данные представляют из себя 7 483 766 наблюдений за 1 месяц (2025-09-30 - 2025-10-30), 23 признака, один из которых - таргет.
Для задачи антифрода и такого большого количества наблюдений в данных достаточно большой таргет рейт ≈ 20%.
Не смотря на то, что в данных 7 млн. транзакций, они принадлежат всего 5 тыс. уникальным клиентам. Таргет рейт для каждого клиента также ≈ 20% (каждый клиент имеет от 200 до 800 мошеннеческих операций).

Флуктуация таргета не наблюдается: 
ВСТАВИТЬ КАРТИНКУ!

Количество наблюдений в динакмике также равномерно распределено.

Анализ данных показал:
- Сумма мошеннических транзакций в среднем в 4 раза больше, чем у легитимных транзакций. Однако при отсечении данных по amount по перцентилям результат был такой, что мошеннических было не более 30% при порогах 75% и 90% (только при установлении порога 99% количество фрауд операций стало 80, что вообще говоря мало). ВСе значения amount > 75-перцинтили - это более 1.5 млн.$., что очень много. Вывод такой, что невозможно точно сказать о характере транзакции, глядя только на сумму транзакции.
- При рассмотрении матрицы корреляции у признаков is_outside_home_country и is_card_present наблюдались очень высокие значения корреляции по отношению к таргету. Если посмотреть на данные, в которых обе эти фичи = 1, т. е. покупка была совершена за пределами страны клиента и карта присутствовала при оплате, то можно увидеть, что все эти наблюдения определяются, как мошеннические. Возможно, это операции совершенные c краденых карт.
- Есть топ-4 страны (Бразилия, Нигерия, Мексика, Россия), в которых мошеннических операций в 6 раз больше, чем в остальных. Для бизнеса, данная статистика должна навести на мысль к пристальному контролю над транзакциями в этих странах.

# Построение модели
Были построены модели основанные на градиентом бустинге LGBMClassifier. Всего было построено 3 модели: на полном списке признаков, на коротком списке признаков (60% от полного), на супер-коротком (4 признака).
Дополнительно для обучения были сгенерированы 2 новых признака:
- country_risk - Географический риск (страны с высоким fraud_rate)
- amount_anomaly - Аномалия суммы (отклонение от среднего клиента)

Для обучения модели данные были поделены на 3 непересекающееся выборки train/valid/out-of-sample. Разделение проходило по клиентам.

| Выборки | train | val | oos |
|:------|:----------|:-----|:-----|
| Количество наблюдений | 3647393 | 1588830 | 2247543 |
| Количество клиентов | 2385 | 1023 | 1461 |
| Таргет рейт | 19.9% | 19.9% | 19.9% |

1. В первую очередь была построена модель на long_list (полный список признаков, за исключением информативных). Проводился подбор гиперпараметром при помощи бибилиотеки optuna. Оптимизировалась метрика PR-AUC. В результате чего модель на oos выборке получила PR-AUC = 0.98 и Джини = 0.99. Что указывает на сильное переобучение. Эта модель строилась для того, чтобы отобрать лучшие признаки и построить другую модель.
2. Модель на short_list. Для данной модели было принято решение все же взять топ-60% признаков по feature importance из модели на long_list. Гиперпараметры подбирались на той же сетке и оптимизировалась та же метрика. Как итог модель получила все те же 0.98 PR-AUC и 0.99 Джини, хотя в процессе побора гиперпараметров было заметно, что метрики на val падают до 0.8
3. Была построена модель всего на топ-4 признаках по feature importance от модели, построенной на short_list. Подбор гиперпараметров проводился так же, как и в двух предыдущих моделях. Модель демонстрирует PR-AUC = 0.81 и Джини 0.82.

Метрики на 3 модели сильно упали. Для улучшения метрики и контроля переобучения возможно постепенное добавление признаков и обучение моделей.

Из обученных моделей можно сделать вывод:
- Судя по feature importance модели очень сильно опирались на признак amount. Даже при обученной модели всего на 4 признаках, фича amount с отрывом от других занимает 1 место.
- Скорее всего в данных присутствует лик среди признаков, которые были удалены после перехода от 2 к 3 модели.
- Хоть признаки is_outside_home_country и is_card_present и имели большую корреляцию с таргетом для моделей они имеют минимальное влияние.

Применение моделей возможно, например, в случае онлайн мониторинга транзакций, что скорее всего труднореализуемо в силу того, что это будет требовать огромных вычислительных ресурсов, чтобы скорить каждую транзакцию.

- Модель могла бы раз в час скорить все проведенные за час транзакции и в случае выявления мошеннической транзакции, замораживать карту и связываться с владельцем.
- Для стран с большим количеством мошеннических операций возможно ввести дополнительное подтсерждение на проведение всех/некоторых операций по каким-то правилам.
